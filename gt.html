<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country and Language Detection</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            color: gray;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        .message {
            font-size: 2rem;
        }
        .flag-img {
            width: 40px;
            height: auto;
            vertical-align: middle;
            margin: 0 10px;
        }
        .fact {
            margin-top: 20px;
            font-size: 2rem;
        }
        .anthem {
            margin-top: 20px;
            font-size: 1.5rem;
        }
        audio {
            margin-top: 10px;
        }
        .translate-btn {
            margin-top: 20px;
            padding: 10px;
            background-color: gray;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        @media (max-width: 600px) {
            .fact {
                font-size: 1.5rem;
                max-width: 300px;
                word-wrap: break-word;
            }
        }
        @media (min-width: 601px) {
            .fact {
                max-width: none;
                word-wrap: normal;
            }
        }
    </style>
</head>
<body>
    <div class="message" id="message">Loading...</div>
    <div class="fact" id="fact"></div>
    <div class="anthem" id="anthem">Searching for national anthem...</div>
    <audio id="anthemPlayer" controls></audio>
    <button id="translateBtn" class="translate-btn" style="display: none;">Translate to Language</button>

    <script>
        async function getCountryByIP() {
            try {
                const [languageResponse, ipResponse] = await Promise.all([
                    fetch('/api/languages'),  // Endpoint to get language data
                    fetch('/api/ip')          // Endpoint to get IP data
                ]);

                const languageData = await languageResponse.json();
                const data = await ipResponse.json();

                if (ipResponse.ok) {
                    const countryCode = data.country_code.toLowerCase();
                    const countryName = data.country_name;
                    let languageCode = getLanguageCode(countryCode, languageData);

                    if (!translations[languageCode]) {
                        languageCode = await getLanguageFromWikipedia(countryName) || await getLanguageFromGoogle(countryName) || 'en';
                    }

                    const translatedHello = translations[languageCode] || translations['en'];
                    const flagImg = await getFlagImageAsPNG(countryCode);
                    const countryFacts = await getCountryFacts(countryName);

                    document.getElementById('message').innerHTML = `You are from ${countryName} <img src="${flagImg}" alt="${countryName} Flag" class="flag-img"> ${translatedHello}`;
                    document.getElementById('fact').innerHTML = countryFacts || '<p>No facts available.</p>';

                    await getNationalAnthem(countryName);
                } else {
                    document.getElementById('message').textContent = 'Unable to determine location.';
                }
            } catch (error) {
                document.getElementById('message').textContent = 'Error retrieving location.';
            }
        }

        function getLanguageCode(countryCode, languageData) {
            const countryLanguageMap = {
                'ae': 'ar',
                'sg': 'zh',
                'hk': 'yue',
                'ar': 'ar',
                'br': 'pt-BR',
                'ua': 'uk',
                'kz': 'kk',
                'ci': 'fr'
            };
            return countryLanguageMap[countryCode] || languageData[countryCode.toUpperCase()] || 'en';
        }

        async function getLanguageFromWikipedia(countryName) {
            try {
                const response = await fetch(`/api/wikipedia?country=${encodeURIComponent(countryName)}`);
                const data = await response.json();
                return extractLanguageFromText(data.text) || '';
            } catch (error) {
                console.error('Error fetching language from Wikipedia:', error);
                return '';
            }
        }

        async function getLanguageFromGoogle(countryName) {
            try {
                const response = await fetch(`/api/google?country=${encodeURIComponent(countryName)}`);
                const data = await response.json();
                return extractLanguageFromText(data.text) || '';
            } catch (error) {
                console.error('Error fetching language from Google:', error);
                return '';
            }
        }

        function extractLanguageFromText(text) {
            const langMatches = text.match(/official\s+language[s]?[\s:]+([^\s<]+)[\s<]/i);
            return langMatches ? langMatches[1].toLowerCase() : '';
        }

        async function getFlagImageAsPNG(countryCode) {
            const svgUrl = `/flags/${countryCode.toUpperCase()}.svg`;
            try {
                const response = await fetch(svgUrl);
                const svgText = await response.text();

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                canvas.width = 40;
                canvas.height = 30;

                return new Promise((resolve, reject) => {
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const pngUrl = canvas.toDataURL('image/png');
                        resolve(pngUrl);
                    };
                    img.onerror = reject;
                    img.src = 'data:image/svg+xml;base64,' + btoa(svgText);
                });
            } catch (error) {
                console.error('Error fetching or converting flag image:', error);
                return '';
            }
        }

        async function getCountryFacts(countryName) {
            const openAIFact = await searchOpenAI(countryName);
            if (openAIFact) {
                return limitFactLength(openAIFact);
            }

            const wikipediaFact = await searchWikipedia(countryName);
            if (wikipediaFact) {
                return limitFactLength(wikipediaFact);
            }

            const googleFact = await searchGoogle(countryName);
            if (googleFact) {
                return limitFactLength(googleFact);
            }

            return 'Here is a general fact about ' + countryName + ': It is a diverse and culturally rich country.';
        }

        async function searchOpenAI(countryName) {
            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        prompt: `Provide a brief fact about ${countryName}`,
                        max_tokens: 60
                    })
                });
                const data = await response.json();
                return data.choices[0].text.trim();
            } catch (error) {
                console.error('Error fetching data from OpenAI:', error);
                return '';
            }
        }

        async function searchWikipedia(countryName) {
            try {
                const response = await fetch(`/api/wikipedia?country=${encodeURIComponent(countryName)}`);
                const data = await response.json();
                return data.text || '';
            } catch (error) {
                console.error('Error fetching data from Wikipedia:', error);
                return '';
            }
        }

        async function searchGoogle(countryName) {
            try {
                const response = await fetch(`/api/google?country=${encodeURIComponent(countryName)}`);
                const data = await response.json();
                return extractFactFromText(data.text);
            } catch (error) {
                console.error('Error fetching data from Google:', error);
                return '';
            }
        }

        function extractFactFromText(text) {
            const factMatch = text.match(/<div[^>]*class="BNeawe[^"]*">([^<]+)<\/div>/);
            return factMatch ? factMatch[1] : '';
        }

        function limitFactLength(fact) {
            return fact.length > 300 ? fact.substring(0, 300) + '...' : fact;
        }

        async function getNationalAnthem(countryName) {
            try {
                const anthemURL = `/anthems/${countryName.replace(/\s+/g, '-').toLowerCase()}.mp3`;
                const response = await fetch(anthemURL);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    document.getElementById('anthemPlayer').src = url;
                    document.getElementById('anthem').textContent = `National Anthem of ${countryName}`;
                } else {
                    document.getElementById('anthem').textContent = 'Anthem not found.';
                }
            } catch (error) {
                console.error('Error fetching national anthem:', error);
                document.getElementById('anthem').textContent = 'Error fetching anthem.';
            }
        }

        const translations = {
            'en': 'Hello',
            'ar': 'مرحبا',
            'zh': '你好',
            'yue': '你好',
            'pt-br': 'Olá',
            'uk': 'Привіт',
            'kk': 'Сәлем',
            'fr': 'Bonjour'
        };

        getCountryByIP();
    </script>
</body>
</html>
